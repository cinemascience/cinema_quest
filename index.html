<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <link rel='stylesheet' href='default.css'>
    <script src="d3.v4.min.js"></script>
    <script src="LineSpace.js"></script>
    <script src="FileLoad.js"></script>
</head>
   <body>
	   <div id="header">
			<h1>Output Explorer</h1>
			<select id="database">
				<option value="GF-HP/GF-HP.csv">GF-HP</option>
				<option value="GF-LP/GF-LP.csv">F-LP</option>
				<option value="LANLHigh-O/LANLHigh-O.csv">LANLHigh-O</option>
				<option value="LANLLow-O/LANLLow-O.csv">LANLLow-O</option>
				<option value="simresults/Al.design.1000.numbered.csv">Flag Simulation</option>
			</select>
		</div>
		<div id="spaceArea">
			<div id="spaceContainer"></div>
		</div>
   		<script>
   			var lineSpace = new LineSpace(d3.select("#spaceContainer"), getGraphProperties, interpolate);

   			var column = -1;

   			d3.csv("data/GF-HP/GF-HP.csv", function(error, results) {
   				params = results;
   				console.log(results[0]);
		         	var q = d3.queue();
		         	results.forEach(function(item, index) {
		            	q.defer(d3.text, item["visar"]);
		   			});
		            q.awaitAll(function(error, results) {
		            	//if (!error) {
			            	var data = [];
				        	results.forEach(function(text, index) {
				        		if (text) {
				        			var rows = d3.tsvParseRows(text).map(function(row) {
					            		return row.map(function(value) {
					            			return +value;
					               		});
					            	});

						            var rows2 = [];
						            var count = 0;
						            rows.forEach(function(item, index) {
						                if (column > 0) {
						               		rows2.push({x : item[0], y : item[column]});
						                }
						                else {
						               		rows2.push({x : count, y : item[1]});
						               		count++;
						                }
						            });

						            var ds = {params: params[index], rows: rows2};
						            data.push(ds);
					        	}
			               		
			           		});

				            lineSpace.data(data);
			           // }
		            });
			});

   			function getGraphProperties(ds) {
   				//return {x: +ds.params[lineSpace.dimensions[0]], y: +ds.params[lineSpace.dimensions[1]], value: +ds.params[lineSpace.dimensions[2]]/2000};
   				return {x: +ds.params[lineSpace.dimensions[0]], y: +ds.params[lineSpace.dimensions[1]], value: +ds.params.run % 5 == 0};
   			}

   			function interpolate(ds, x, y) {
   				var newDs = ds;
   				newDs.params[lineSpace.dimensions[0]] = x;
   				newDs.params[lineSpace.dimensions[1]] = y;
   				//console.log();

   				var dsDist = [];
   				lineSpace.dataSet.forEach(function(item, index) {
   					var x1 = (x-item.params[lineSpace.dimensions[0]]);
   					var x2 = (y-item.params[lineSpace.dimensions[1]]);
   					var distance = Math.sqrt(x1*x1 + x2*x2);
   					//console.log(distance);
   					if ((item.params.run % 5) != 0) {
   						dsDist.push({id: index, distance: distance, weight: 1/(distance*distance)});
   					}
   				});

				dsDist.sort(function(a, b){return a.distance-b.distance});

				var weightSum = 0;
				for (var f = 0; f < 5; f++) {
					weightSum += dsDist[f].weight;
				}

				var rows = [];
				for (var f = 0; f < 5; f++) {
					lineSpace.dataSet[dsDist[f].id].rows.forEach(function(item, index) {
						if (f == 0) {
							rows.push({x: item.x, y: item.y*dsDist[f].weight/weightSum});
						}
						else {
							rows[index].y += item.y*dsDist[f].weight/weightSum;
						}
					});
				}

				newDs.rows = rows;

   				//console.log(dsDist[0].distance, dsDist[0].weight, dsDist[0].id, weightSum);

   				//newDs.rows = lineSpace.dataSet[Math.floor(Math.random()*lineSpace.dataSet.length)].rows;
   				return newDs;
   			}

   		</script>
   </body>
</html>
